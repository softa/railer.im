:javascript
  ls = []
%h2 Live view
#map.map.span-16{:style => 'height:400px; margin-bottom:30px;'}
.new_users_list_wrapper.span-8.last
  %ul
    - for user in User.recent.six
      :javascript 
        ls.push([#{user.lat}, #{user.lng}, '#{user.name}'])
      = render :partial => 'user_row', :locals => {:user => user}
%script{:src => "http://maps.google.com/maps/api/js?sensor=false&hl=pt-br"}
:javascript 
  last_id = #{User.recent.first.id rescue 0}
  $(function(){
    var latlng = new google.maps.LatLng(0,0);
    var options = {
      zoom: 2,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map"), options);
    for(i=0;i<ls.length;i++){
      var latlng = new google.maps.LatLng(ls[i][0], ls[i][1])
      new google.maps.Marker({title:ls[i][2], icon:'/images/icons/ruby.png',position:latlng,map:map});
    }
  })
  live = function(){
    $.getJSON('/home/live?last_id=' + last_id, function(data){
      if( ! data.length ) return
      $('.accesses em.none').slideUp("slow")
      for(i in data){
        if(data[i].lat && data[i].lng){
          var latlng = new google.maps.LatLng(data[i].lat, data[i].lng)
          map.panTo(new google.maps.LatLng(data[i].lat, data[i].lng));
          new google.maps.Marker({title:data[i].title, icon:'/images/icons/ruby.png',position:latlng,map:map});
        }
        new_li = $(data[i].html)
        $('.new_users_list_wrapper ul').prepend(new_li)
        new_li.slideDown("slow");
        last_id = data[i].id
      }
    })
    setTimeout( live, 6000 )
  }
  setTimeout( live, 3000 )